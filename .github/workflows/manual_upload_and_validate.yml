name: Manual Upload & Validate

on:
  workflow_dispatch:

jobs:
  validate-and-upload:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
      - name: Install server deps
        working-directory: ./server
        run: npm ci
      - name: Validate envs
        working-directory: ./server
        run: node ./scripts/validate_envs.js
      - name: Upload firebase secret (if available)
        if: ${{ secrets.GCP_SA_KEY && secrets.FIREBASE_ACCOUNT_JSON && secrets.FIREBASE_PROJECT_ID }}
        run: |
          echo "Preparing to upload firebase secret via gcloud..."
          echo "${{ secrets.GCP_SA_KEY }}" > /tmp/sa.json
          echo "${{ secrets.FIREBASE_ACCOUNT_JSON }}" > /tmp/firebase.json
          gcloud auth activate-service-account --key-file=/tmp/sa.json
          gcloud config set project "${{ secrets.FIREBASE_PROJECT_ID }}"
          SECRET_NAME=${{ secrets.FIREBASE_SECRET_NAME || 'firebase-service-account' }}
          if ! gcloud secrets describe "$SECRET_NAME" >/dev/null 2>&1; then
            gcloud secrets create "$SECRET_NAME" --replication-policy="automatic"
          fi
          gcloud secrets versions add "$SECRET_NAME" --data-file=/tmp/firebase.json
        env:
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
